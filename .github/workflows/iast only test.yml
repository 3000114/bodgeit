name: BodgeIt ZAP Runtime Scan

on:
  push:
  pull_request:

permissions:
  contents: read
  issues: write

jobs:
  security-runtime:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download OpenTelemetry Java Agent
        run: |
          curl -L -o otel-agent.jar \
            https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar

      - name: Start BodgeIt (instrumented)
        run: |
          docker network create zap-net

          docker run -d \
            --name bodgeit \
            --network zap-net \
            -p 8080:8080 \
            -e JAVA_TOOL_OPTIONS="-javaagent:/otel/otel-agent.jar \
              -Dotel.service.name=bodgeit \
              -Dotel.metrics.exporter=none \
              -Dotel.logs.exporter=none" \
            -v $PWD/otel-agent.jar:/otel/otel-agent.jar \
            psiinon/bodgeit

          sleep 30

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          target: http://bodgeit:8080/bodgeit
          docker_name: ghcr.io/zaproxy/zaproxy:stable
          fail_action: false
          artifact_name: zap_baseline_scan
